### TCP 的四次挥手（TCP Connection Teardown）

TCP（Transmission Control Protocol，传输控制协议）在断开连接时需要 **四次挥手（Four-Way Handshake）**，以保证双方可以优雅地终止通信。其过程如下：

------

#### **1️⃣ 第一次挥手（Client → FIN）**

- **发送方（主动关闭连接的一方）** 发送 **FIN（Finish）** 报文，表示自己已经 **没有数据要发送**，请求关闭连接。
- **此时，发送方进入 FIN_WAIT_1 状态**，等待对方的确认。

📌 **报文格式：**

```
SEQ = x, ACK = 0, FIN = 1
```

------

#### **2️⃣ 第二次挥手（Server → ACK）**

- **接收方（被动关闭连接的一方）** 收到 FIN 后，发送 **ACK（确认）** 报文，表示**收到关闭请求**，但由于 TCP 是**全双工通信**，接收方**可能仍有数据要发送**，因此连接不会立即关闭。
- **此时，接收方进入 CLOSE_WAIT 状态**，发送方进入 `FIN_WAIT_2` 状态，等待最终的 FIN。

📌 **报文格式：**

```
SEQ = y, ACK = x+1, FIN = 0
```

------

#### **3️⃣ 第三次挥手（Server → FIN）**

- **接收方处理完数据后**，主动发送 **FIN** 报文，表示自己也没有数据要发送了，请求关闭连接。
- **此时，接收方进入 LAST_ACK 状态**，等待最后的 ACK。

📌 **报文格式：**

```
SEQ = z, ACK = x+1, FIN = 1
```

------

#### **4️⃣ 第四次挥手（Client → ACK）**

- **发送方收到 FIN 后**，发送 **ACK（确认）** 报文，表示同意关闭连接。
- **此时，发送方进入 TIME_WAIT 状态，并等待 2MSL（最大报文生存时间）后才真正关闭连接，确保对方收到 ACK**。
- **接收方收到 ACK 后，立即进入 CLOSED 状态，连接关闭。**

📌 **报文格式：**

```
SEQ = x+1, ACK = z+1, FIN = 0
```

------

### **为什么需要四次挥手？**

- **TCP 是全双工协议**，数据的发送和接收是**独立的**，需要双方都主动关闭各自的数据流，因此需要两次 FIN（即四次挥手）。
- 若采用**三次挥手**，则接收方可能还未发送完数据，就直接断开连接，导致数据丢失。

------

### **为什么 TIME_WAIT 需要等 2MSL？**

1. 保证最后的 ACK 能够被对方接收到

   ： 

   - 如果 ACK 丢失，服务器会重发 FIN，如果没有 `TIME_WAIT`，ACK 无法再次发送。

2. 防止旧的重复数据包干扰新连接

   ： 

   - 若立即关闭，可能会有旧的 TCP 报文在网络中残留，影响新的连接。

------

### **总结**

| **挥手次数**     | **发送方（Client）** | **接收方（Server）** | **状态变化**                |
| ---------------- | -------------------- | -------------------- | --------------------------- |
| **1️⃣ 第一次挥手** | `FIN`                | —                    | `FIN_WAIT_1`                |
| **2️⃣ 第二次挥手** | —                    | `ACK`                | `CLOSE_WAIT` / `FIN_WAIT_2` |
| **3️⃣ 第三次挥手** | —                    | `FIN`                | `LAST_ACK`                  |
| **4️⃣ 第四次挥手** | `ACK`                | —                    | `TIME_WAIT` / `CLOSED`      |

------

这样，TCP 连接就安全、可靠地断开了 🚀。